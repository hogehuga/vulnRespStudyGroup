# Web Shellマルウェアの検出と防止

## 概要

攻撃者は、コンピュータネットワークの悪用のためのWeb Shell マルウェアの使用を増加させています[1][2][3][4]。Web Shell マルウェアはハッカーによって用意されるソフトウェアで、通常は被害者のWebサーバ上に配備されます。これを使用して任意のシステムコマンドを実行することができ、一般的には HTTP または HTTPS で送信されます。Web Shell 攻撃は、国防総省のコンポーネント（訳注：DoD components）に深刻なリスクをもたらします。攻撃者は、既存のWebアプリケーションにファイルを追加したり変更したりすることで、Web Shell を作成することがよくあります。Web Shell は、正規のトラフィックに紛れ込むように偽装された通信チャネルを使用して、攻撃者に侵害されたネットワークへの持続的なアクセスを提供します。Web Shell マルウェアは、多くのセキュリティ ツールを回避し続けている、長年にわたって蔓延している脅威です。

サイバー犯罪者は、Webアプリケーションの脆弱性を悪用したり、他の方法で感染したシステムにアップロードしたりすることで、Web Shell を展開します。Web Shell は、永続的なバックドアとして機能したり、攻撃者のコマンドを他のシステムに転送する中継ノードとして機能したりします。攻撃者は、侵害された複数のシステム上のWeb Shell をチェーン化して、インターネットに接続したシステムから内部ネットワークへと通信をルーティングすることが頻繁にあります[5]。

Web Shell の標的にされるのはインターネットに接続したシステムだけだというのは、よくある誤解です。攻撃者は、内部コンテンツ管理システムやネットワークデバイス管理インターフェイスなど、インターネットに面していないWebサーバ上にWeb Shell を展開することがよくあります。内部のWebアプリケーションは、パッチ管理の遅れや許容範囲の広いセキュリティ要件のために、侵害されやすくなります。

「Web Shell」という用語は、主にマルウェアと関連していますが、管理者が合法的に使用しているウェブベースのシステム管理ツールを指すこともあります。このガイダンスの論点ではありませんが、これらの無害なWeb Shell は、これらのツールの弱点がシステムの侵害につながる可能性があるため、組織に危険をもたらす可能性があります。管理者は、エンタープライズの認証方式、セキュアな通信チャネル、セキュリティ強化を活用したシステム管理ソフトウェアを使用するべきです。

## 緩和策（検出）

Web Shell は攻撃者によって容易に更新され、暗号化/エンコード/難読化を採用していることが多いため、検出が困難です。複数の検出機能を使用した徹底した防御のアプローチは、Web Shell マルウェアを発見する可能性が高いです。Web Shell の検出方法は、無害なファイルに誤ってフラグを立てることがあります。Web Shell の可能性があるファイルが検出された場合、管理者はそのファイルの出所と信頼性を検証する必要があります。検出手法には以下のようなものがあります。

###	"既知の正常な状態" との比較

Web Shell は、主に既存のWebアプリケーションを対象とし、ファイルの作成や修正に依存しています。これらのWeb Shell を検出する最良の方法は、Webアプリケーションの検証済みの良性バージョン（つまり「既知の正常」）を本番環境と比較することです。不一致がある場合は、手動で真正性を確認してください。良否判定をするための追加情報とスクリプトは付録Aにあり、下記で管理されています。https://github.com/nsacyber/Mitigating-Web-Shells

既知の良好なイメージとの不一致を判断する際には、管理者は不審なシステムのタイムスタンプを信頼しないように気を付ける必要があります。
攻撃者の中には、「timestomping」[6]と呼ばれる手法を使用して、Web Shell ファイルに正当性を持たせる為、作成及び変更された時間を変更します。
管理者は、メンテナンス期間中に発生したと思われるという理由だけで、変更が本物であると想定しないで下さい。但し、最初のトリアージ方法として、管理者は異常なタイムスタンプを持つファイルの検証を優先することを選択できます。

###	ウェブトラフィックの異常検出

攻撃者は通常のウェブトラフィックに紛れ込むようにWeb Shell を設計することがよくありますが、高度な知識がなければいくつかの特性を模倣することは困難です。そのような特徴には、ユーザーエージェント（User agent）の文字列やクライアントのインターネットプロトコル（IP）アドレス空間などがあります。ネットワークに参加する前に、攻撃者はどのユーザーエージェント（User agent）や IP アドレスがWebサーバの典型的なものであるかを知ることができないため、Web Shell のリクエストは異常に見えてしまいます。さらに、攻撃者のトラフィックをルーティングするWeb Shell は、デフォルトでWebサーバのユーザーエージェントと IP アドレスを使用しますが、これはネットワークトラフィックでは珍しいはずです。異常なユーザーエージェントによって排他的にアクセスされるURI（Uniform Resource Identifiers）は、潜在的にWeb Shell である可能性があります。最後に、攻撃者の中には、Web Shell のリクエスト「参照元[sic]ヘッダ（referrer [sic] header）」（※1）を通常のトラフィックとして偽装することを怠っています。したがって、リファラーヘッダが欠落していたり、異常リファラーヘッダを持っていたりするリクエストは、Web Shell の存在を示す可能性があります。セキュリティ情報とイベント管理（SIEM）システムなどの集中型ログクエリ機能は、この分析を実装する手段を提供します。
このような機能が利用できない場合、管理者はスクリプトを使用して Web サーバのログを解析し、Web シェルの URI を特定することができます。例えば、Splunk®（※2） クエリの例（付録 B）、ログデータを分析するためのスクリプト（付録 C）、及び Webトラフィック以上の検出に関する追加情報は以下にあります。
https://github.com/nsacyber/Mitigating-Web-Shells

###	シグネチャベースの検出
ホストの視点から見ると、Web Shell は難読化されている可能性があり、変更が容易であるため、シグネチャベースの検出（signature-based detection）は信頼できません。しかし、一部の攻撃者は、一般的な（人気のある）Web Shell （China Chopper、WSO、C99、B374K、R57 など）を最小限の変更で使用しています。このような場合、fingerprintやexpression-basedの検出が可能な場合があります。一般的なWeb Shell ファイルを検出するための Snort®（※3） ルール集、スキャン手順、シグネチャベースの検出に関する追加情報は以下にあります。
https://github.com/nsacyber/Mitigating-Web-Shells

ネットワークの観点から見るとWeb Shell の通信は難読かまたは暗号化されることが多いため、Web Shellのシグネチャベースの検出は信頼できません。さらに、変数名のような「ハードコードされた」値は、検出をさらに回避するために簡単に変更できます。未知のWeb Shell を発見することはほとんどありませんが、シグネチャベースのネットワーク検出は、既知のWeb Shell の追加の感染を特定するのに役立ちます。付録 D には、攻撃者によって展開されることがある一般的な、変更されていない、あるいはわずかに変更されたWeb Shell からのネットワーク通信を検出するためのシグネチャのコレクションが用意されています。このリストは、以下にもあります。
https://github.com/nsacyber/Mitigating-Web-Shells

###	予期せぬネットワークフロー
場合によっては、攻撃者はWebサーバ以外のシステム（ワークステーションなど）でWeb Shell を使用します。これらのWeb Shell は、不正なWebサーバプリケーション上で動作し、メモリ内だけで実行することでファイルベースの検出を回避することができます（即ち、ファイルレス実行）。これらのタイプのWeb Shell は機能的には従来のリモートアクセスツール（RAT）と似ていますが、攻撃者が悪意のあるトラフィックを統一されたプラットフォームを介して簡単に連鎖させることを可能にします。この種のWeb Shell は、以前に使用されていなかったポートをリッスンして応答するため、十分に管理されたネットワーク上で検出することができます。さらに、攻撃者が境界Webサーバを使用してネットワークにトラフィックをトンネルする場合、境界デバイスから内部ノードへの接続が行われます。

管理者がネットワーク上のどのノードがWebサーバとして動作しているかを把握していれば、ネットワーク解析によってこのような予期せぬフローを明らかにすることができます。脆弱性スキャナー（Nessus®（※4）など）、侵入検知システム（Snort®など）、ネットワーク・セキュリティ・モニター（Zeek™（※5） [旧「Bro」]など）などのさまざまなツールを使用することで、ネットワーク内の不正なWebサーバの存在を明らかにすることができます。予想されるネットワーク・アクティビティの完全かつ正確な記録を維持することで、多くのタイプの攻撃に対する防御を強化することができます。付録EのSnort®ルールと https://github.com/nsacyber/Mitigating-Web-Shells で管理されているSnor® ルールは、予期しないネットワークフローを特定するために、特定のネットワークに合わせて調整することができます。

###	エンドポイント検出および応答（EDR）機能
EDRや強化されたホスト ロギング ソリューションの中には、システムコールやプロセスの系統異常に基づいてWebシェルを検出できるものがあります。これらのセキュリティ製品は、呼び出されたシステムコールを含むエンドポイント上の各プロセスを監視します。Web Shell は通常、Webサーバ・プロセスが異常な動作を示す原因となります。例えば、ほとんどの無害なWebサーバが ipconfig ユーティリティを起動するのは珍しいことですが、これはWeb Shell によって有効になる一般的な偵察手法です。EDRには様々な自動化機能とクエリインターフェースがあるため、ドキュメントを確認するか、ベンダーとWeb Shell検出について話し合うことをお勧めします。付録Fでは、Sysmonの強化されたプロセス ロギング データを使用して、Microsoft® Windows®（※6）環境でプロセスの異常を識別する方法を説明しています。同様に、付録Gでは、Linux®（※7）環境でのプロセス異常を識別するためにauditdをどのように使用できるかを説明しています。これらの環境でプロセス異常を識別するためのガイダンスは、https://github.com/nsacyber/Mitigating-Web-Shells にも掲載されています。

###	その他の異常なネットワークトラフィック指標

攻撃者によっては、Web Shell のトラフィックが他の検出可能な異常な特徴を示す可能性があります。特に、異常に大きな応答（データの漏洩の可能性）、ピーク時以外での繰り返しのアクセス（非ローカルの計画されていない作業）、地理的にばらばらなリクエスト（外部オペレータの可能性）は、潜在的なWeb Shell の URIを示している可能性があります。但し、これらの特性は非常に主観的であり、多くの無害なURIにフラグを立てる可能性があります。管理者は、ベースラインの特性が環境で統一されている場合、これらの検出分析を実装することを選択できます。

## 緩和策（予防）
Web Shell を防ぐことは、インターネットに接続したサーバと内部のWebサーバの両方で優先すべきことです。優れたサイバー衛生（Cyber hygiene）と、以下の緩和策に基づく多層防御のアプローチにより、Web Shell に対する防御を大幅に強化することができます。防御技術には以下のようなものがあります。

###	Webアプリケーションの更新の優先順位付け

攻撃者は、パッチリリースから24時間以内に、インターネット向けアプリケーションや内部のWebアプリケーションの脆弱性を標的にすることがあります。
パッチが利用可能になり次第、これらのアプリケーションを更新してください。
可能な限り、自動更新を有効にし、頻繁に更新するように設定してください（少なくとも毎日）。自動更新が不可能な場合は、手動更新を頻繁に実施してください。
付録 H には、一般的に悪用されている脆弱性がいくつか記載されています。

###	Webアプリケーションの許可

Web サービスは最小特権セキュリティパラダイム（訳注：枠組み）に従うべきです。特にWeb アプリケーションは、Webアクセス可能なディレクトリに直接書き込んだり、Webアクセス可能なコードを変更したりする権限を持ってはいけません（訳注：shuld not have）。WebサーバがWebアクセス可能なディレクトリへのアクセスをブロックしている場合、攻撃者は脆弱なアプリケーションにWebシェルをアップロードできません。一部のWebアプリケーションのでは、アップロードされたものをWebからアクセスできない領域に保存するための設定変更が必要です。この緩和策を実装する前にドキュメントを参照するか、Webアプリケーションベンダーと変更について話し合ってください。

###	ファイルの完全性の監視

管理者が上記のようにWebアプリケーションのパーミッションを強化できない場合、ファイル整合性の監視を行うことで同様の効果を得ることができます。ファイル整合性ソフトウェア（訳注：File integrity software）は、Web アクセス可能なディレクトリへのファイル変更をブロックしたり、変更があった場合に警告を出したりすることができます。さらに、監視ソフトウェアには、特定のファイルの変更を許可し、他のファイルをブロックするという利点があります。
例えば 内部の Web アプリケーションが Portable Document Format （PDF） ファイルのみを処理する場合、整合性監視は「.pdf」拡張子のないファイルアップロードをブロックすることができます。
付録 I では、Web アクセス可能なディレクトリのファイル完全性を強制するために McAfee®（※8） ホスト ベース セキュリティ システム （HBSS） と一緒に使用するためのホスト侵入防止システム （HIPS） ルールのセットを提供しています。これらのルール、実装手順、およびファイル整合性の監視に関する追加情報は、https://github.com/nsacyber/Mitigating-Web-Shells に掲載されています。

###	侵入防止

侵入防御システム（IPS）とWebアプリケーションファイアウォール（WAF）はそれぞれ、既知の攻撃をブロックすることでWebアプリケーションの防御層を追加します。組織は、既知の悪意のあるアップロードをブロックするために、これらのアプライアンスを実装すべきです（訳注：Organizations should implementation these appliances …）。可能であれば、管理者は、特定の悪意のあるアップロードをブロックするためのパターンを含む OWASP™（※9） コアルールセットを実装することを推奨します。
シグネチャベースのブロッキングと同様に、攻撃者は検出を回避する方法を見つけるため、このアプローチは、多層防御戦略の一部分に過ぎません。IPS および WAF アプライアンスは、最初の侵害をブロックすることはできても、Web Shell トラフィックを検出する可能性は低いことに注意してください。保護を最大化するためには、すべてのWebサーバで単一のソリューションを使用するのではなく、個々のWebアプリケーションに合わせてセキュリティアプライアンスを調整する必要があります。

例えば、組織のコンテンツ管理システム用に設定されたセキュリティアプライアンスには、他のWebアプリケーションには当てはまらない、ターゲットを絞った弱点を強化するためのアプリケーション固有のルールを含めることができます。
さらに、セキュリティアプライアンスは、新しい脅威をリアルタイムで軽減するためのアップデートを受信する必要があります。

###	ネットワークの分離

ネットワーク分離は複雑なアーキテクチャ上の課題であり、正しく実行された場合には大きなメリットが得られます。ネットワーク分離は、無関係なネットワークセグメント間の接続を防ぐことで、Web Shell の伝播を妨げます。ネットワーク分離の最も単純な形態は、非武装地帯（DMZ）サブネットを分離して、インターネットに直接接続されたサーバを隔離することです。高度なネットワーク分離では、ソフトウェア定義ネットワーク（SDN）を使用して、ノード間の通信に明示的な認証が必要なZero Trust（※10）アーキテクチャを有効にします。Web Shellは依然としてターゲットサーバに影響を与える可能性がありますが、ネットワークセグメンテーションにより、攻撃者がWeb Shellを連鎖させて組織のネットワークの奥深くまで到達することを防ぎます。ネットワーク分離の詳細については、 nsa.gov の「Segregate Networks and Functions [7]」を参照してください。

###	Webサーバの強化

Web サーバや Web アプリケーションを安全に設定することで、Web Shell やその他の侵害を防ぐことができます。
管理者は、未使用のポートやサービスへのアクセスをブロックする必要があります （訳注：should block）。
使用されているサービスは、可能であれば、想定されるクライアントに限定するべきです（訳注：should be restricted）。
さらに、定期的な脆弱性スキャンは、環境の未知の弱点を特定するのに役立ちます。
ホストベースのセキュリティシステムの中には、機械学習やファイルレピュテーションなどの高度な機能を提供しているものがあり、Web Shell からある程度の保護を提供しています。
組織は、可能な限りこれらの高度なセキュリティ機能を活用すべきです。

## 緩和策（対応と回復）

Web Shell の中には、メモリからのみ実行されて永続化しないものもあれば、ウェブディレクトリ内のバイナリやスクリプトとしてしか存在しないものもありますが、高度な永続化メカニズムによって深く根を張っているものもあります。
いずれにしても、これらはより大規模な侵入キャンペーンの一部である可能性があります。
Web Shell が発見された場合、攻撃者がネットワーク内にどこまで侵入したかが重要な焦点となります。
パケット・キャプチャ（PCAP）とネットワーク フロー データは、Web Shell がネットワーク内でピボットに使用されていたかどうか、どこまで侵入していたかを判断するのに役立ちます。
もし、そのようなピボットを、侵入の全範囲を確認し攻撃者を排除しないまま対処した場合、後日他のチャンネルを介してアクセスを取り戻される可能性があります。

-----

- ※1：「Referer」はインターネット技術標準化委員会RFC 7231で指定されたHTTPヘッダです
- ※2：Splunkは、Splunk, Inc. の登録商標です
- ※3：Snortは、Cisco Technologies, Inc. の登録商標です
- ※4：Nessusは、Tenable Network Security, Inc. の登録商標です
- ※5：Zeekは、Zeek Project の登録商標です
- ※6：Microsoft及びWindowsは、Microsoft Corporation の登録商標です
- ※7：Linuxは、Linux Foundation の登録商標です
- ※8：McAfeeは、McAfee, LLC の登録商標です
- ※9：OWASPは、OWASP財団 の登録商標です

## Appendix A-I：省略

## 引用

（訳注：但し、本翻訳文のみ）

- [1] Microsoft Detection and Response Team （2020）, Ghost in the shell: Investigating web shell attacks. [Online] Available at: https://microsoft.com/security/blog/2020/02/04/ghost-in-the-shell-investigating-web-shell-attacks/ [Accessed Apr. 6, 2020]
- [2] Rascagneres, P. and Svajcer, V. （2019）. China Chopper still active 9 years later. [Online] Available at: https://blog.talosintelligence.com/2019/08/china-chopper-still-active-9-years-later.html [Accessed Apr. 6, 2020]
- [3] CISA （2017）, Alert TA15-314A. [Online] Available at: https://www.us-cert.gov/ncas/alerts/TA15-314A [Accessed Apr. 6, 2020]
- [4] CISA （2018）, Alert AA18-284A. [Online] Available at: https://www.us-cert.gov/ncas/alerts/AA18-284A [Accessed Apr. 6, 2020]
- [5] ACSC （2015）, Web Shells – Threat Awareness and Guidance. [Online] Available at https://cyber.gov.au/sites/default/files/2019- 03/ACSC_Web_Shells.pdf [Accessed Apr. 6, 2020]
- [6] Dumont, R. （2017）, MITRE ATT&CK Framework - Timestomp. [Online] Available at https://attack.mitre.org/techniques/T1099/ [Accessed Apr. 6, 2020]
- [7] NSA （2016）, Segregate Networks and Functions. [Online] Available at https://apps.nsa.gov/iaarchive/library/ia-guidance/securitytips/segregate-networks-and-functions.cfm [Accessed Apr. 6, 2020]
